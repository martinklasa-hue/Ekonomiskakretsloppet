<!-- /embed-standalone.html  -->
<!doctype html>
<html lang="sv">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Ekonomiskt kretslopp – Interaktiv</title>
    <!-- Tailwind via CDN (ok för demo/embedding) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      html,body,#root{height:100%}
      body{background:#f8fafc}
    </style>
  </head>
  <body>
    <div id="root"></div>

    <script type="module">
      // Importer från CDN
      import * as React from "https://esm.sh/react@18?dev";
      import { createRoot } from "https://esm.sh/react-dom@18/client?dev";
      import { motion } from "https://esm.sh/framer-motion@11?dev";
      import {
        Info, Play, Pause, RotateCcw, HelpCircle,
        Home, Factory, Landmark, Banknote, Globe2, X
      } from "https://esm.sh/lucide-react@0.453.0?dev&bundle";

      // === Ekonomiskt kretslopp-komponenten (kortad: samma logik som i canvas) ===

      /** Typdefinitioner (JSDoc istället för TS) */
      /** @typedef {"hushall"|"foretag"|"offentlig"|"bank"|"utland"} SectorId */

      const SECTOR_ORDER = ["hushall","foretag","utland","offentlig","bank"];

      const SECTORS = [
        { id:"hushall", name:"Hushåll", description:"Privatpersoner ...", Icon:Home },
        { id:"foretag", name:"Företag", description:"Producerar varor/tjänster ...", Icon:Factory },
        { id:"offentlig", name:"Offentlig sektor", description:"Staten, regioner, kommuner ...", Icon:Landmark },
        { id:"bank", name:"Bank", description:"Banker – förmedlar sparande och lån ...", Icon:Banknote },
        { id:"utland", name:"Utland", description:"Export, import, betalningar med omvärlden.", Icon:Globe2 },
      ];

      const FLOWS = [
        { id:"lon", from:"foretag", to:"hushall", label:"Löner", explanation:"Företag betalar lön." },
        { id:"konsumtion", from:"hushall", to:"foretag", label:"Konsumtion", explanation:"Hushåll köper varor/tjänster." },
        { id:"skatt_hush", from:"hushall", to:"offentlig", label:"Skatt", explanation:"Inkomstskatter/avgifter." },
        { id:"skatt_foret", from:"foretag", to:"offentlig", label:"Bolagsskatt/avgifter", explanation:"Skatter & AG." },
        { id:"transfereringar", from:"offentlig", to:"hushall", label:"Bidrag/transfereringar", explanation:"Bidrag, pensioner m.m." },
        { id:"offentlig_kop", from:"offentlig", to:"foretag", label:"Offentlig konsumtion/upphandling", explanation:"Köp av varor/tjänster." },
        { id:"sparande", from:"hushall", to:"bank", label:"Sparande", explanation:"Placeringar i bank/fonder." },
        { id:"lanelyft_foret", from:"bank", to:"foretag", label:"Lån till investeringar", explanation:"Utlåning till företag." },
        { id:"lan_hush", from:"bank", to:"hushall", label:"Lån till hushåll", explanation:"Bolån/konsumtionslån." },
        { id:"ranta_hush", from:"bank", to:"hushall", label:"Ränta/avkastning", explanation:"Avkastning på sparande." },
        { id:"export", from:"foretag", to:"utland", label:"Export", explanation:"Säljer till utlandet." },
        { id:"import", from:"utland", to:"foretag", label:"Import", explanation:"Köp av insatsvaror/tjänster." },
      ];

      // Geometri
      const WIDTH=760, HEIGHT=460, CENTER={x:WIDTH/2,y:HEIGHT/2}, RING_R=160;
      const NODE_R = { hushall:46, foretag:46, offentlig:52, bank:44, utland:44 };

      const polarToXY = (a, r) => ({ x:CENTER.x + Math.cos(a)*r, y:CENTER.y + Math.sin(a)*r });
      function sectorPositions(order){
        const step = (Math.PI*2)/order.length;
        return order.reduce((acc,id,i)=>{
          const a = -Math.PI/2 + i*step;
          acc[id]=polarToXY(a, RING_R); return acc;
        }, {});
      }
      const NODE_POS = sectorPositions(SECTOR_ORDER);

      function pathBetween(from,to,curve=0.25){
        const dx=to.x-from.x, dy=to.y-from.y;
        const cx1=from.x+dx*curve, cy1=from.y+dy*curve*0.2;
        const cx2=to.x-dx*curve, cy2=to.y-dy*curve*0.2;
        return `M ${from.x} ${from.y} C ${cx1} ${cy1}, ${cx2} ${cy2}, ${to.x} ${to.y}`;
      }
      function computeLabel(from,to,label){
        const mx=(from.x+to.x)/2, my=(from.y+to.y)/2;
        const dx=to.x-from.x, dy=to.y-from.y;
        const angle=Math.atan2(dy,dx)*180/Math.PI;
        const nx=-dy, ny=dx;
        const outx=mx-CENTER.x, outy=my-CENTER.y;
        const sign=(nx*outx+ny*outy)>=0 ? 1 : -1;
        const nlen=Math.hypot(nx,ny)||1, offset=12;
        const lx=mx+(nx/nlen)*offset*sign, ly=my+(ny/nlen)*offset*sign;
        const w=Math.max(40, Math.min(180, label.length*7+12)), h=18;
        return {x:lx,y:ly,angle,w,h};
      }

      function useFlows(selected){
        const outgoing = React.useMemo(()=>FLOWS.filter(f=>!selected||f.from===selected),[selected]);
        const incoming = React.useMemo(()=>FLOWS.filter(f=>!selected||f.to===selected),[selected]);
        return { outgoing, incoming };
      }
      const getSector = id => SECTORS.find(s=>s.id===id);

      function App(){
        const [selected,setSelected]=React.useState();
        const [showBanner,setShowBanner]=React.useState(false);
        const [playing,setPlaying]=React.useState(false);
        const [step,setStep]=React.useState(0);

        const {outgoing,incoming}=useFlows(selected);
        const steps=FLOWS;
        const currentFlow=steps[step];

        React.useEffect(()=>{
          if(!playing) return;
          const id=setInterval(()=>{
            setStep(s=>(s+1)%steps.length);
            const next=steps[(step+1)%steps.length];
            setSelected(next.from); setShowBanner(true);
          },1800);
          return ()=>clearInterval(id);
        },[playing,step]);

        React.useEffect(()=>{ if(selected) setShowBanner(true); },[selected]);
        React.useEffect(()=>{
          const onKey=e=>{ if(e.key==="Escape") setShowBanner(false); };
          window.addEventListener("keydown",onKey);
          return ()=>window.removeEventListener("keydown",onKey);
        },[]);

        return (
          React.createElement("div",{className:"w-full h-full p-4 md:p-6 lg:p-8 bg-slate-50"},
            React.createElement("div",{className:"max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-[1fr_360px] gap-4"},
              // Vänster
              React.createElement("div",{className:"bg-white rounded-2xl shadow p-4 md:p-6 relative overflow-visible"},
                React.createElement("div",{className:"flex items-center justify-between mb-4"},
                  React.createElement("h1",{className:"text-2xl font-semibold"},"Ekonomiskt kretslopp"),
                  React.createElement("div",{className:"flex items-center gap-2"},
                    React.createElement("button",{className:"inline-flex items-center gap-1 rounded-2xl px-3 py-2 border text-sm hover:bg-slate-100", onClick:()=>setPlaying(v=>!v)},
                      playing?React.createElement(Pause,{className:"w-4 h-4"}):React.createElement(Play,{className:"w-4 h-4"}),
                      playing?" Pausa":" Spela flödet"
                    ),
                    React.createElement("button",{className:"inline-flex items-center gap-1 rounded-2xl px-3 py-2 border text-sm hover:bg-slate-100",
                      onClick:()=>{ setPlaying(false); setStep(0); setSelected(undefined); }},
                      React.createElement(RotateCcw,{className:"w-4 h-4"})," Återställ"
                    ),
                    React.createElement("div",{className:"ml-2 text-slate-500",title:"Klicka på en ikon"},
                      React.createElement(HelpCircle,{className:"w-5 h-5"})
                    )
                  )
                ),

                // Banner
                selected && showBanner && React.createElement(motion.div,{
                  initial:{y:-24,opacity:0}, animate:{y:0,opacity:1}, className:"absolute -top-3 left-4 right-4 z-20"
                },
                  React.createElement("div",{className:"bg-slate-900 text-white rounded-2xl shadow-xl ring-1 ring-black/10 px-4 py-3"},
                    React.createElement("div",{className:"flex items-start gap-3"},
                      React.createElement("div",{className:"flex-1"},
                        React.createElement("div",{className:"text-sm uppercase tracking-wide text-slate-300"}, getSector(selected).name),
                        React.createElement("div",{className:"text-base font-semibold"},"Vart pengarna går & varifrån de kommer"),
                        React.createElement("div",{className:"mt-2 grid grid-cols-1 md:grid-cols-2 gap-3 text-sm"},
                          React.createElement("div",null,
                            React.createElement("div",{className:"text-slate-300"},"Kommer från"),
                            React.createElement("ul",{className:"mt-1 flex flex-wrap gap-2"},
                              incoming.length?incoming.map(f=>
                                React.createElement("li",{key:f.id,className:"px-2 py-1 rounded-full bg-white/10"},
                                  React.createElement("span",{className:"font-medium"},f.label),
                                  React.createElement("span",{className:"opacity-80"}," • ", getSector(f.from).name)
                                )
                              ):React.createElement("li",{className:"opacity-70"},"— Inga direkta inflöden —")
                            )
                          ),
                          React.createElement("div",null,
                            React.createElement("div",{className:"text-slate-300"},"Går till"),
                            React.createElement("ul",{className:"mt-1 flex flex-wrap gap-2"},
                              outgoing.length?outgoing.map(f=>
                                React.createElement("li",{key:f.id,className:"px-2 py-1 rounded-full bg-white/10"},
                                  React.createElement("span",{className:"font-medium"},f.label),
                                  React.createElement("span",{className:"opacity-80"}," • ", getSector(f.to).name)
                                )
                              ):React.createElement("li",{className:"opacity-70"},"— Inga direkta utflöden —")
                            )
                          )
                        )
                      ),
                      React.createElement("button",{className:"shrink-0 p-1 -mr-1 rounded-lg hover:bg-white/10", onClick:()=>setShowBanner(false)},
                        React.createElement(X,{className:"w-5 h-5"})
                      )
                    )
                  )
                ),

                // SVG
                React.createElement("div",{className:"relative"},
                  React.createElement("svg",{viewBox:`0 0 ${WIDTH} ${HEIGHT}`, className:"w-full h-auto"},
                    React.createElement("circle",{cx:CENTER.x, cy:CENTER.y, r:RING_R, fill:"none", stroke:"#e2e8f0", strokeWidth:8}),
                    React.createElement("circle",{cx:CENTER.x, cy:CENTER.y, r:RING_R, fill:"none", stroke:"#64748b", strokeDasharray:"6 10", strokeWidth:1.5, opacity:0.6}),
                    FLOWS.map(f=>{
                      const from=NODE_POS[f.from], to=NODE_POS[f.to];
                      const showFlow = selected ? (f.from===selected||f.to===selected) : false;
                      if(!showFlow) return null;
                      const isActive = f.from===selected || f.to===selected;
                      const d=pathBetween(from,to,0.25);
                      const lp=computeLabel(from,to,f.label);
                      return React.createElement("g",{key:f.id},
                        React.createElement("path",{d, fill:"none", stroke:isActive?"#0f172a":"#cbd5e1", strokeWidth:isActive?3:2, opacity:isActive?0.95:0.85,
                          markerEnd:"url(#arrow)"}),
                        React.createElement("g",{transform:`translate(${lp.x},${lp.y}) rotate(${lp.angle})`},
                          React.createElement("rect",{x:-lp.w/2,y:-lp.h/2,width:lp.w,height:lp.h,rx:6,ry:6,fill:"#fff",opacity:0.95}),
                          React.createElement("text",{textAnchor:"middle",dominantBaseline:"central",fontSize:12, className:isActive?"fill-slate-900":"fill-slate-700"}, f.label)
                        )
                      );
                    }),
                    React.createElement("defs",null,
                      React.createElement("marker",{id:"arrow", markerWidth:10, markerHeight:10, refX:10, refY:5, orient:"auto-start-reverse"},
                        React.createElement("path",{d:"M 0 0 L 10 5 L 0 10 z", fill:"#0f172a"})
                      )
                    ),
                    SECTORS.map(s=>{
                      const pos=NODE_POS[s.id], r=NODE_R[s.id]; const active=selected===s.id; const Icon=s.Icon;
                      return React.createElement("g",{key:s.id, className:"cursor-pointer", onClick:()=>{ setSelected(s.id); setShowBanner(true); }},
                        React.createElement(motion.circle,{cx:pos.x, cy:pos.y, r, fill:active?"#0f172a":"#f1f5f9", stroke:active?"#0f172a":"#cbd5e1", strokeWidth:active?2.5:1.5, whileHover:{scale:1.06}, whileTap:{scale:0.98}}),
                        React.createElement("g",{transform:`translate(${pos.x-14},${pos.y-22})`},
                          React.createElement(Icon,{size:28, color:active?"#ffffff":"#0f172a"})
                        ),
                        React.createElement("text",{x:pos.x, y:pos.y + r - 10, textAnchor:"middle", className:`text-[12px] font-medium ${active?"fill-slate-900":"fill-slate-700"}`}, s.name)
                      );
                    })
                  )
                )
              ),

              // Höger: enkel textpanel (kortad)
              React.createElement("div",{className:"bg-white rounded-2xl shadow p-4 md:p-6 h-max"},
                React.createElement("div",{className:"flex items-center gap-2 mb-3"},
                  React.createElement(Info,{className:"w-5 h-5 text-slate-700"}),
                  React.createElement("h2",{className:"text-xl font-semibold"},"Utforskning")
                ),
                React.createElement("div",{className:"space-y-3"},
                  React.createElement("div",null,
                    React.createElement("div",{className:"text-slate-500 text-sm"},"Vald aktör"),
                    React.createElement("div",{className:"text-lg font-medium"}, selected?getSector(selected).name:"— klicka på en ikon —")
                  )
                )
              )
            )
          )
        );
      }

      createRoot(document.getElementById("root")).render(React.createElement(App));
    </script>
  </body>
</html>

